<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Furniture 3D Demo</title>
  <script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
  <style>/* your CSS stays unchanged */</style>
</head>
<body>

  <!-- Unchanged HTML layout -->

  <script>
    const isIOS = /iPhone|iPad|iPod/i.test(navigator.userAgent);
    const isMobile = /Mobi|Android|iPhone|iPad|iPod/i.test(navigator.userAgent);
    const arButton = document.getElementById('ar-button');
    const nextBtn = document.getElementById('next-btn');
    const image = document.getElementById('model-image');
    const qrWrapper = document.getElementById('qr-wrapper');
    const qrClose = document.getElementById('qr-close');
    const qrIosImg = document.getElementById('qr-ios');
    const qrAndroidImg = document.getElementById('qr-android');

    const SUPABASE_URL = 'https://pknidxbkalbstzfquvsv.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBrbmlkeGJrYWxic3R6ZnF1dnN2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM3Mjk0MjAsImV4cCI6MjA2OTMwNTQyMH0.Tz8XJMd7FG4UAPc4Twy3ndeTAWiulyRL95zaxS8sPOA';

    const models = [
      {
        name: "Bed",
        image: "https://raw.githubusercontent.com/soumbhat/somemodels/main/bed.png",
        glb: "bed.glb",
        usdz: "https://huggingface.co/datasets/soumbhat/Demo_furniture/resolve/main/bed.usdz"
      },
      {
        name: "Sofa",
        image: "https://raw.githubusercontent.com/soumbhat/somemodels/main/untitled-shoot-sofa.jpg",
        glb: "https://raw.githubusercontent.com/soumbhat/somemodels/main/texture_mesh_c59b717cae6ac53f_shaded.glb",
        usdz: "https://huggingface.co/datasets/soumbhat/Demo_furniture/resolve/main/texture_mesh_c59b717cae6ac53f_shaded%20(1).usdz",
        qr_ios: "https://github.com/soumbhat/somemodels/blob/main/qrcode_sofa_ios.png?raw=true",
        qr_android: "https://github.com/soumbhat/somemodels/blob/main/qrcode_sofa_android.png?raw=true"
      }
    ];

    let currentIndex = 0;

    function updateImage() {
      image.src = models[currentIndex].image;
    }

    async function getSignedBedUrl() {
      const res = await fetch(`${SUPABASE_URL}/storage/v1/object/sign/ar-models-furniture/bed.glb?expiresIn=3600`, {
        method: 'POST',
        headers: {
          apikey: SUPABASE_ANON_KEY,
          Authorization: `Bearer ${SUPABASE_ANON_KEY}`,
          'Content-Type': 'application/json'
        }
      });

      const { signedURL } = await res.json();
      return `${SUPABASE_URL}${signedURL}`;
    }

    async function handleAR() {
      const model = models[currentIndex];
      if (model.name === "Bed") {
        const signedUrl = await getSignedBedUrl();
        const encoded = encodeURIComponent(signedUrl);

        if (isIOS) {
          window.location.href = model.usdz;
        } else if (!isMobile) {
          const androidLink = `https://arvr.google.com/scene-viewer/1.0?file=${encoded}&mode=ar_preferred`;
          qrIosImg.src = await new Promise(resolve => QRCode.toDataURL(androidLink, (_, url) => resolve(url)));
          qrAndroidImg.src = qrIosImg.src;
          qrWrapper.style.display = 'flex';
        } else {
          const intentUrl = `intent://arvr.google.com/scene-viewer/1.0?file=${encoded}&mode=ar_preferred#Intent;scheme=https;package=com.google.ar.core;action=android.intent.action.VIEW;end;`;
          window.location.href = intentUrl;
        }
      } else {
        // Sofa uses static links
        if (isIOS) {
          window.location.href = model.usdz;
        } else if (!isMobile) {
          qrIosImg.src = model.qr_ios;
          qrAndroidImg.src = model.qr_android;
          qrWrapper.style.display = 'flex';
        } else {
          const encoded = encodeURIComponent(model.glb);
          const intentUrl = `intent://arvr.google.com/scene-viewer/1.0?file=${encoded}&mode=ar_preferred#Intent;scheme=https;package=com.google.ar.core;action=android.intent.action.VIEW;end;`;
          window.location.href = intentUrl;
        }
      }
    }

    function updateQRCodes() {
      const model = models[currentIndex];
      if (model.qr_ios) qrIosImg.src = model.qr_ios;
      if (model.qr_android) qrAndroidImg.src = model.qr_android;
    }

    nextBtn.addEventListener('click', () => {
      currentIndex = (currentIndex + 1) % models.length;
      updateImage();
      if (!isMobile) updateQRCodes();
    });

    qrClose.addEventListener('click', () => {
      qrWrapper.style.display = 'none';
    });

    arButton.addEventListener('click', handleAR);

    updateImage();
    if (!isMobile) updateQRCodes();
  </script>
</body>
</html>
